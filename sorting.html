<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>sorting.at</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/s.css">
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="js/AlgorithmView2.js" charset="utf-8"></script>
</head>
<body>
	<div id="algorithms"></div>
	<script>



		function Sorting(options) {

			var WIDTH=900,
				HEIGHT=400;

			var data=options.data || [],
				container=options.container || "#algorithms",
				algorithms_container=d3.select(container);

			var sorting=options.sorting || [];

			var algoviz=[];

			var steps={};

			var functions={
				"quicksort":QuickSort(),
				"mergesort":MergeSort(),
				"smoothsort":SmoothSort()
			}

			var algorithms=algorithms_container.selectAll("div.algorithm")
									.data(sorting)
									.enter()
									.append("div")
										.attr("class","algorithm")
										.attr("id",function(d,i){
											return d+"_"+i;
										})
										.attr("rel",function(d){
											return d;
										})

			
			algorithms.each(function(d,i){

				steps[d]=functions[d](cloneArray(data));
				var items=[];
				items.push(cloneArray(data));

				console.log("#"+d3.select(this).attr("id"))
				algoviz.push(
					new AlgorithmView({
						container:"#"+d3.select(this).attr("id"),
						width:WIDTH,
						height:HEIGHT,
						steps:steps[d],
						items:items,
						grouping:1,
						callback:function(){
							//d3.select("#stepper span")
							//	.text(qs_view.getStepsLength() - qs_view.getCurrentStep())
						}
					})
				)

			})

			/* PUBLIC FUNCTIONS */
			this.race=function(){
				algoviz.forEach(function(a){
					a.animate();
				})
			}
			this.nextStep=function(){
				algoviz.forEach(function(a){
					a.stepNext();
				})
			}
			

			/* SUPPORT FUNCTIONS */
			function addStep(steps,index,from,to) {
				console.log(index,from,"->",to)
				if(from==to)
					return;
				steps[steps.length-1].push({
	            	index:index,
	            	from:from,
	            	to:to
	            });
			}


			function swap(steps,list, a, b) {
				steps.push([]);
				addStep(steps,list[a],a,b);
				addStep(steps,list[b],b,a);

				var tmp=list[a];
				list[a]=list[b];
				list[b]=tmp;


			}

			function cloneArray(A) {
				var B=[];
				for(var i=0;i<A.length;i++) {
					B.push(A[i]);
				}
				return B;
			}


			/* SORTING ALGORITHMS */
			function QuickSort() {
				var steps=[];

				//http://en.wikibooks.org/wiki/Algorithm_Implementation/Sorting/Quicksort
				//without in-line partition ==> function name: quick
				function quicksort(array, start, end){

				    if(start < end){
				        var l=start+1, r=end, p = array[start];
				        while(l<r){
				            if(array[l] <= p)
				                l++;
				            else if(array[r] >= p)
				                r--;
				            else
				                swap(steps,array,l,r);
				        }
				        if(array[l] < p){
				            swap(steps,array,l,start);
				            l--;
				        }
				        else{
				            l--;
				            swap(steps,array,l,start);
				        }
				        quicksort(array, start, l);
				        quicksort(array, r, end);
				    }
				}

				return function(array) {
					quicksort(array,0,array.length-1);
					return steps.filter(function(d){
						return d.length>0;
					});
				}

			}

			function MergeSort() {
				var steps=[];


				function mergeSort(a, low, height) {

				    var l = low;
				    var h = height;

				    //console.log(l,">=",h)

				    if (l >= h) {
				    	
				        return a;
				    }

				    var mid = Math.floor((l + h) / 2);


				    //console.log(l,mid);
				    //console.log(mid+1,h);
				    
				    mergeSort(a, l, mid);
				    mergeSort(a, mid + 1, h);

				    var end_lo = mid;
				    var start_hi = mid + 1;
				    while ((l <= end_lo) && (start_hi <= h)) {
				    	steps.push([]);
				        if (a[l]<a[start_hi]) {
				            l++;
				        } else {
				            var temp = a[start_hi];
				            for (var k = start_hi - 1; k >= l; k--) {
				                addStep(steps,a[k],k,k+1)
				                a[k + 1] = a[k];
				                /*
				                RedrawItem(k + 1);
				                pnlSamples.Refresh();
				                if (chkCreateAnimation.Checked)
				                    SavePicture();
				                */
				                //items.push(cloneArray(a));

				            }
				            addStep(steps,temp,start_hi,l)
				            a[l] = temp;
				            //items.push(cloneArray(a));
				            /*
				            RedrawItem(l);
				            pnlSamples.Refresh();
				            if (chkCreateAnimation.Checked)
				                SavePicture();
				            */
				            l++;
				            end_lo++;
				            start_hi++;
				        }
				    }
				    //console.log(a)
				    return a;
				}

				return function(array) {
					mergeSort(array,0,array.length-1);
					return steps.filter(function(d){
						return d.length>0;
					});
				}
			}

			
			function SmoothSort() {
				var steps=[];
				var compare = ascending;

				// Leonardo numbers.
				var LP = [
					1, 1, 3, 5, 9, 15, 25, 41, 67, 109, 177, 287, 465, 753, 
					1219, 1973, 3193, 5167, 8361, 13529, 21891, 35421, 57313, 92735,
					150049, 242785, 392835, 635621, 1028457, 1664079, 2692537, 
					4356617, 7049155, 11405773, 18454929, 29860703, 48315633, 78176337,
					126491971, 204668309, 331160281, 535828591, 866988873
					];

				function sort(m, lo, hi) {

			      if (arguments.length === 1) {
			        lo = 0;
			        hi = m.length - 1;
			      }
			      if (hi > LP[32]) {
			        throw {error: "Maximum length exceeded for smoothsort implementation."};
			      }
			      var head = lo,
			          p = 1,
			          pshift = 1,
			          trail;

			      while (head < hi) {
			        if ((p & 3) === 3) {
			          sift(m, pshift, head);
			          p >>>= 2;
			          pshift += 2;
			        } else {
			          if (LP[pshift - 1] >= hi - head) trinkle(m, p, pshift, head, false);
			          else sift(m, pshift, head);
			          if (pshift === 1) {
			            p <<= 1;
			            pshift--;
			          } else {
			            p <<= (pshift - 1);
			            pshift = 1;
			          }
			        }
			        p |= 1;
			        head++;
			        
			      }
			      trinkle(m, p, pshift, head, false);

			      while (pshift !== 1 || p !== 1) {
			        if (pshift <= 1) {
			          trail = trailingzeroes(p & ~1);
			          p >>>= trail;
			          pshift += trail;
			        } else {
			          p <<= 2;
			          p ^= 7;
			          pshift -= 2;

			          trinkle(m, p >>> 1, pshift + 1, head - LP[pshift] - 1, true);
			          trinkle(m, p, pshift, head - 1, true);
			        }

			        head--;
			        
			      }
			      
			    }

				function trinkle(m, p, pshift, head, trusty) {
			      var val = m[head],
			          stepson,
			          mstepson,
			          rt,
			          lf,
			          trail;
			      var val_old_pos=m.indexOf(val);
			      steps.push([]);
			      while (p !== 1) {
			        stepson = head - LP[pshift];

			        if (compare(mstepson = m[stepson], val) <= 0) break;

			        if (!trusty && pshift > 1) {
			          rt = head - 1;
			          lf = head - 1 - LP[pshift - 2];
			          if (compare(m[rt], mstepson) >= 0 || compare(m[lf], mstepson) >= 0) {
			            break;
			          }
			        }
			        console.log("t1",cloneArray(m),mstepson,m.indexOf(mstepson),"->",head,"::",steps.length-1)
			        addStep(steps,mstepson,m.indexOf(mstepson),head);
			        /*
			        steps[steps.length-1].push({
		            	index:mstepson,
		            	from:m.indexOf(mstepson),
		            	to:head
		            });
					*/
			        m[head] = mstepson;
			        //items.push(cloneArray(m));
			        

			        head = stepson;
			        trail = trailingzeroes(p & ~1);
			        p >>>= trail;
			        pshift += trail;
			        trusty = false;
			        
			      }
			      if (!trusty) {
			        console.log("t2",cloneArray(m),val,val_old_pos,"->",head,"::",steps.length-1)
			        addStep(steps,val,val_old_pos,head);
			        /*
			        steps[steps.length-1].push({
		            	index:val,
		            	from:val_old_pos,
		            	to:head
		            });*/
			        m[head] = val;
			        //items.push(cloneArray(m));
			        
			        sift(m, pshift, head);
			      }
			      
			    }

				function sift(m, pshift, head) {
			      var rt,
			          lf,
			          mrt,
			          mlf,
			          val = m[head];
			      var val_old_pos=m.indexOf(val);
			      steps.push([]);
			      while (pshift > 1) {
			      	
			        rt = head - 1;
			        lf = head - 1 - LP[pshift - 2];
			        mrt = m[rt];
			        mlf = m[lf];

			        if (compare(val, mlf) >= 0 && compare(val, mrt) >= 0) break;

			        if (compare(mlf, mrt) >= 0) {
			          console.log("s",cloneArray(m),mlf,m.indexOf(mlf),"->",head,"::",steps.length-1)
			          addStep(steps,mlf,m.indexOf(mlf),head);
			          
			          m[head] = mlf;
			          
			          head = lf;
			          pshift--;
			        } else {
			          console.log("s",cloneArray(m),mrt,m.indexOf(mrt),"->",head,"::",steps.length-1)
			          addStep(steps,mrt,m.indexOf(mrt),head);
			          
			          m[head] = mrt;
			          
			          head = rt;
			          pshift -= 2;
			        }
			        
			        //items.push(cloneArray(m));
			      	//console.log("s1",cloneArray(m))
			      }
			      console.log("s2",cloneArray(m),val,val_old_pos,"->",head,"::",steps.length-1)
			      addStep(steps,val,val_old_pos,head);
			      /*
			      steps[steps.length-1].push({
	            	index:val,
	            	from:val_old_pos,
	            	to:head
	              });
					*/
			      m[head] = val;
			      //items.push(cloneArray(m));
			      
			    }

				// Solution for determining number of trailing zeroes of a number's binary representation.
				// Taken from http://www.0xe3.com/text/ntz/ComputingTrailingZerosHOWTO.html
				var MultiplyDeBruijnBitPosition = [
					0,  1, 28,  2, 29, 14, 24, 3,
					30, 22, 20, 15, 25, 17,  4, 8,
					31, 27, 13, 23, 21, 19, 16, 7,
					26, 12, 18,  6, 11,  5, 10, 9];

				function trailingzeroes(v) {
					return MultiplyDeBruijnBitPosition[(((v & -v) * 0x077CB531) >> 27) & 0x1f];
				}

				function ascending(a, b) {
					return a < b ? -1 : a > b ? 1 : a >= b ? 0 : NaN;
				}

				return function(array) {
					sort(array,0,array.length-1);
					//console.log(array)
					return steps.filter(function(d){
						return d.length>0;
					});
				}
			}
			
			//new Quicksort([3,2,1])

			//var merge=MergeSort()(cloneArray(data));
			var smooth=SmoothSort()(cloneArray(data));

		};

		function shuffle(o){ //v1.0
			console.log("shuffling")
			for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
			return o;
		};

		var sorting=new Sorting({
			container:"#algorithms",
			sorting:["quicksort","mergesort","smoothsort"],
			//sorting:["smoothsort"],
			data:shuffle([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19])
		});



	</script>
</body>
</html>